<!doctype html>
<html lang="id">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>WA Reminder Dashboard</title>
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <script src="https://cdn.jsdelivr.net/npm/xlsx/dist/xlsx.full.min.js"></script>
  </head>
  <body class="bg-light">
    <div class="container py-5">
      <h2 class="mb-4">üìã WA Reminder Dashboard</h2>

      <div class="card p-3 mb-3">
        <form id="form-add">
          <div class="row g-2 align-items-center">
            <div class="col-md-3">
              <input
                class="form-control"
                id="name"
                name="name"
                placeholder="Nama"
                required
              />
            </div>
            <div class="col-md-3">
              <input
                class="form-control"
                id="phone"
                name="phone"
                placeholder="+628..."
                required
              />
            </div>
            <div class="col-md-2">
              <input
                class="form-control"
                id="due_date"
                name="due_date"
                type="date"
                required
              />
            </div>
            <div class="col-md-2">
              <input
                class="form-control"
                id="amount"
                name="amount"
                type="number"
                placeholder="Jumlah"
                required
              />
            </div>
            <div class="col-md-2 text-end">
              <button class="btn btn-primary" type="submit">
                Tambah Nasabah
              </button>
            </div>
          </div>
        </form>
      </div>

      <div class="card p-3 mb-3">
        <div class="row g-2 align-items-center">
          <div class="col-md-8">
            <input
              id="excelFile"
              type="file"
              accept=".xlsx,.xls"
              class="form-control"
            />
          </div>
          <div class="col-md-4 text-end">
            <button id="btnUpload" class="btn btn-success">Upload Excel</button>
          </div>
        </div>
      </div>

      <div class="card p-3">
        <div class="table-responsive">
          <table class="table table-striped align-middle">
            <thead class="table-dark">
              <tr>
                <th>Nama</th>
                <th>Phone</th>
                <th>Date</th>
                <th>Amount</th>
                <th>Status</th>
              </tr>
            </thead>
            <tbody id="tbody"></tbody>
          </table>
        </div>
        <button id="btnRefresh" class="btn btn-outline-primary">Refresh</button>
      </div>
    </div>

    <script>
      const api = {
        getInvoices: "/.netlify/functions/get_invoices",
        addNasabah: "/.netlify/functions/add_nasabah",
      };

      async function load() {
        const tbody = document.getElementById("tbody");
        tbody.innerHTML =
          '<tr><td colspan="5" class="text-center">‚è≥ Memuat data...</td></tr>';
        try {
          const res = await fetch(api.getInvoices);
          const result = await res.json();
          const data = result.rows || [];
          if (!data.length) {
            tbody.innerHTML =
              '<tr><td colspan="5" class="text-center text-muted">Belum ada data</td></tr>';
            return;
          }
          tbody.innerHTML = data
            .map(
              (inv) => `
              <tr>
                <td>${inv.name}</td>
                <td>${inv.phone}</td>
                <td>${inv.due_date}</td>
                <td>${Number(inv.amount).toLocaleString("id-ID")}</td>
                <td>${inv.status}</td>
              </tr>`
            )
            .join("");
        } catch (err) {
          tbody.innerHTML =
            '<tr><td colspan="5" class="text-danger text-center">Gagal memuat data</td></tr>';
        }
      }

      document
        .getElementById("form-add")
        .addEventListener("submit", async (e) => {
          e.preventDefault();
          const fd = new FormData(e.target);
          const body = {
            name: fd.get("name"),
            phone: fd.get("phone"),
            due_date: fd.get("due_date"),
            amount: Number(fd.get("amount")),
            message: "",
          };
          await fetch(api.addNasabah, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(body),
          });
          e.target.reset();
          load();
        });

      document
        .getElementById("btnUpload")
        .addEventListener("click", async (e) => {
          e.preventDefault();
          const fileInput = document.getElementById("excelFile");
          if (!fileInput.files.length) return alert("Pilih file Excel dulu!");
          const file = fileInput.files[0];
          const reader = new FileReader();
          reader.onload = async (evt) => {
            const workbook = XLSX.read(evt.target.result, { type: "array" });
            const sheet = workbook.Sheets[workbook.SheetNames[0]];
            const json = XLSX.utils.sheet_to_json(sheet, { defval: "" });
            const resp = await fetch(api.addNasabah, {
              method: "POST",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify(json),
            });
            alert("Upload berhasil!");
            load();
          };
          reader.readAsArrayBuffer(file);
        });

      document
        .getElementById("btnRefresh")
        .addEventListener("click", () => load());
      window.addEventListener("load", load);
    </script>
  </body>
</html>
